<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mentoring Comfamiliar | Innovation Nexus</title>
    <!-- Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            /* Indigo 500 */
            --primary-dark: #4338ca;
            /* Indigo 700 */
            --secondary: #8b5cf6;
            /* Violet 500 */
            --accent: #10b981;
            /* Emerald 500 */
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            /* Lighter background for better text contrast */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 95%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 95%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 98%, 1) 0, transparent 50%);
            background-size: 100% 100%;
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
        }

        /* Logo Contrast Fix */
        .logo-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            padding: 1rem;
            border-radius: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Innovation Nexus Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes floating {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        .delay-300 {
            animation-delay: 0.3s;
        }

        /* Custom Inputs */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            outline: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            transition: color 0.3s ease;
        }

        .input-field:focus+.input-icon {
            color: var(--primary);
        }

        /* Timeline Stream */
        .timeline-stream {
            position: relative;
            padding-left: 2rem;
            border-left: 2px solid #e2e8f0;
        }

        .timeline-node {
            position: absolute;
            left: -2.6rem;
            top: 0;
            width: 3rem;
            height: 3rem;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Toast & Bento Specifics */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 100;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            min-width: 300px;
        }

        .toast.success {
            border-left: 4px solid var(--accent);
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>

<body class="text-slate-700 min-h-screen">
    <!-- Configuration -->
    <input type="hidden" id="api-url"
        value="https://script.google.com/macros/s/AKfycbxDoMZZaxG1g8Cufc4bDb_WBfuzlLg0W-wDmFgjcEU98AEgwSQM_PfTOGy0CxOx0n5u/exec">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- VIEW: LOGIN (Split Layout) -->
    <div id="login-view" class="flex min-h-screen w-full bg-white relative overflow-hidden">

        <!-- Left Column: Image Hero -->
        <div class="hidden lg:flex lg:w-[60%] relative bg-slate-900 overflow-hidden">
            <div class="absolute inset-0">
                <img src="https://i.imgur.com/9RYlUP4.png" alt="Innovation Nexus"
                    class="w-full h-full object-cover opacity-90">
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>

            <div class="relative z-10 flex flex-col justify-end p-16 h-full text-white space-y-6">
                <div class="w-16 h-1 border-t-4 border-emerald-400 mb-4 slide-up"></div>
                <h1 class="text-6xl font-extrabold leading-tight slide-up delay-100">
                    El futuro no se espera,<br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">se
                        construye.</span>
                </h1>
                <p class="text-xl text-slate-300 max-w-xl font-light slide-up delay-200">
                    nete al programa de Mentoring Comfamiliar y conecta con las mentes que est谩n transformando la
                    organizaci贸n.
                </p>
            </div>
        </div>

        <!-- Right Column: Login Form -->
        <div class="w-full lg:w-[40%] flex flex-col justify-center items-center p-8 relative">
            <!-- Mobile Background Hint -->
            <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 to-purple-50 lg:hidden -z-10"></div>

            <div class="w-full max-w-md space-y-10 slide-up delay-300">
                <!-- Header -->
                <div class="text-center lg:text-left space-y-2">
                    <div class="logo-bg mb-6 mx-auto lg:mx-0 shadow-xl">
                        <img src="https://i.imgur.com/yyI6FWO.png" alt="Logo" class="h-12 w-auto drop-shadow-sm">
                    </div>
                    <h2 class="text-3xl font-bold text-slate-900">Bienvenido de nuevo</h2>
                    <p class="text-slate-500">Ingresa tus credenciales para acceder al Nexus</p>
                </div>

                <!-- Form -->
                <div class="space-y-6">
                    <div class="input-group">
                        <input type="text" id="email-input" class="input-field peer" placeholder=" " autocomplete="off">
                        <label
                            class="absolute left-10 top-4 text-slate-400 text-sm transition-all 
                                    peer-focus:-top-2 peer-focus:left-3 peer-focus:text-xs peer-focus:bg-white peer-focus:px-1 peer-focus:text-indigo-600
                                    peer-not-placeholder-shown:-top-2 peer-not-placeholder-shown:left-3 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:bg-white peer-not-placeholder-shown:px-1">
                            Correo Corporativo
                        </label>
                        <i data-lucide="mail" class="input-icon w-5 h-5"></i>
                    </div>

                    <button onclick="app.login()"
                        class="group w-full py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl 
                                     hover:shadow-2xl hover:bg-black transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center gap-3 overflow-hidden relative">
                        <span class="relative z-10">Ingresar al Portal</span>
                        <i data-lucide="arrow-right"
                            class="w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"></i>
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                    </button>
                </div>

                <!-- Footer -->
                <div class="text-center text-sm text-slate-400 pt-8">
                    &copy; 2025 Gesti贸n Humana y Desarrollo
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace View -->
    <div id="workspace-view" class="hidden min-h-screen relative z-10 flex">

        <!-- Floating Sidebar -->
        <aside
            class="fixed left-4 top-4 bottom-4 w-20 glass glass-card rounded-2xl flex flex-col items-center py-8 z-50 hidden md:flex">
            <!-- Logo Icon -->
            <div
                class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold mb-8 shadow-lg shadow-indigo-500/30">
                <i data-lucide="zap" class="w-6 h-6"></i>
            </div>

            <!-- Nav Items -->
            <div class="flex flex-col gap-6 flex-1 w-full px-2">
                <button
                    class="w-full aspect-square rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center relative group">
                    <i data-lucide="layout-grid" class="w-6 h-6"></i>
                    <div
                        class="absolute left-14 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                        Dashboard</div>
                </button>
                <div class="h-px bg-slate-200 w-10 mx-auto"></div>
                <button onclick="app.logout()"
                    class="w-full aspect-square rounded-xl text-slate-400 hover:bg-slate-50 hover:text-red-500 flex items-center justify-center transition-colors relative group">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                    <div
                        class="absolute left-14 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                        Cerrar Sesi贸n</div>
                </button>
            </div>

            <!-- User Avatar (Bottom) -->
            <div class="mt-auto relative group cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white shadow-sm overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="User"
                        class="w-full h-full object-cover" id="sidebar-avatar">
                </div>
                <!-- Tooltip User Info -->
                <div
                    class="absolute left-14 bottom-0 bg-white glass-card p-4 rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap min-w-[150px]">
                    <p id="user-name-display" class="font-bold text-slate-800 text-sm">Usuario</p>
                    <p id="user-role-display" class="text-xs text-indigo-500 font-medium">Mentee</p>
                </div>
            </div>
        </aside>

        <!-- Mobile Header (Visible only on small screens) -->
        <header class="md:hidden fixed top-0 left-0 right-0 h-16 glass flex items-center justify-between px-4 z-50">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold">
                    M</div>
                <span class="font-bold text-slate-800">Mentoring</span>
            </div>
            <button onclick="app.logout()" class="p-2 text-slate-500"><i data-lucide="log-out"
                    class="w-5 h-5"></i></button>
        </header>

        <main class="flex-1 container mx-auto px-4 py-8 md:ml-24 max-w-6xl space-y-8 mt-16 md:mt-0">
            <!-- Welcome Section -->
            <!-- UNIFIED HERO GRID (Welcome + Stats + Action) -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 slide-up">

                <!-- Main Hero Card: Greeting & Progress -->
                <div
                    class="lg:col-span-3 glass glass-card p-8 rounded-3xl relative overflow-hidden flex flex-col md:flex-row items-center justify-between gap-8">
                    <!-- Decor: Background Gradient -->
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
                    </div>

                    <!-- Left: Greeting & Spark -->
                    <div class="relative z-10 flex-1 text-center md:text-left">
                        <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">
                            <span id="greeting-text">Hola</span>,
                            <span id="welcome-name"
                                class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Compa帽ero</span>
                            
                        </h2>
                        <!-- Daily Spark -->
                        <div id="daily-spark"
                            class="mt-2 hidden fade-in inline-block bg-amber-50/80 border border-amber-100 rounded-lg px-3 py-1.5">
                            <p
                                class="text-slate-600 font-medium italic text-sm flex items-center gap-2 justify-center md:justify-start">
                                <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                                "<span id="spark-quote">Tu crecimiento es nuestro crecimiento.</span>"
                            </p>
                        </div>
                    </div>

                    <!-- Right: Compact Progress Widget -->
                    <div
                        class="relative z-10 flex items-center gap-4 bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm">
                        <div class="text-right">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tu Avance</p>
                            <div class="flex items-baseline justify-end gap-1">
                                <span id="completed-count" class="text-2xl font-bold text-slate-800">0</span>
                                <span class="text-slate-400 font-medium text-sm">/ 6</span>
                            </div>
                        </div>
                        <!-- Ring -->
                        <div class="relative w-14 h-14">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="28" cy="28" r="24" stroke="#e2e8f0" stroke-width="4" fill="none"></circle>
                                <circle id="progress-ring" cx="28" cy="28" r="24" stroke="#4f46e5" stroke-width="4"
                                    fill="none" stroke-dasharray="150.7" stroke-dashoffset="150.7"
                                    class="transition-all duration-1000 ease-out"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i data-lucide="award" class="w-5 h-5 text-indigo-500"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Card: New Session -->
                <button onclick="app.openModal('session-modal')"
                    class="lg:col-span-1 group glass glass-card p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:bg-indigo-600 hover:text-white transition-all duration-300 cursor-pointer relative overflow-hidden shadow-lg shadow-indigo-500/10 hover:shadow-indigo-500/30">
                    <!-- Button Content -->
                    <div
                        class="w-14 h-14 bg-indigo-100/50 rounded-full flex items-center justify-center group-hover:bg-white/20 group-hover:scale-110 transition-transform mb-1">
                        <i data-lucide="plus"
                            class="w-8 h-8 text-indigo-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-bold text-lg text-slate-700 group-hover:text-white">Nueva Sesi贸n</span>
                    <span class="text-xs text-slate-400 group-hover:text-indigo-100 font-medium">Registrar avance</span>
                </button>

            </div>

            <!-- Sessions Timeline/Grid -->
            <div class="slide-up delay-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-800">Historial de Sesiones</h3>
                    <div class="flex gap-2">
                        <span
                            class="px-3 py-1 bg-white rounded-full text-xs font-medium text-slate-500 shadow-sm border border-slate-100">Total:
                            <span id="total-sessions">0</span></span>
                    </div>
                </div>

                <div id="sessions-list" class="grid gap-4 timeline-line relative pl-0 md:pl-0">
                    <div class="glass glass-card p-8 rounded-2xl text-center text-slate-500">
                        <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-3 text-slate-300"></i>
                        <p>No hay sesiones registradas a煤n</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard View -->
    <div id="admin-view" class="hidden min-h-screen bg-slate-50/50 pb-20 relative z-10">
        <header
            class="sticky top-0 z-50 border-b border-indigo-500/20 bg-slate-900/90 backdrop-blur-md text-white shadow-lg shadow-indigo-500/10">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shadow-indigo-500/50 shadow-md">
                        A</div>
                    <span class="font-bold text-white tracking-wide">Command Center</span>
                </div>
                <button onclick="app.logout()"
                    class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-red-400 transition-colors"
                    title="Cerrar Sesi贸n">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 space-y-8">
            <!-- KPIs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-card p-5 rounded-xl border-l-4 border-indigo-500">
                    <p class="text-slate-500 text-sm font-medium">Total Sesiones</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-1" id="kpi-total">0</h3>
                </div>
                <div class="glass-card p-5 rounded-xl border-l-4 border-emerald-500">
                    <p class="text-slate-500 text-sm font-medium">Duplas Activas</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-1" id="kpi-active">0</h3>
                </div>
                <div class="glass-card p-5 rounded-xl border-l-4 border-blue-500">
                    <p class="text-slate-500 text-sm font-medium">Horas Totales</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-1" id="kpi-hours">0</h3>
                </div>
                <div class="glass-card p-5 rounded-xl border-l-4 border-purple-500">
                    <p class="text-slate-500 text-sm font-medium">Media Sesiones/Dupla</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-1" id="kpi-avg">0</h3>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card p-6 rounded-xl flex flex-col">
                    <h4 class="font-semibold text-slate-800 mb-4">Sesiones por Mes</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-xl flex flex-col">
                    <h4 class="font-semibold text-slate-800 mb-4">Estado de Duplas</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table & Routes -->
            <div class="space-y-6">
                <!-- Header Actions -->
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">Gesti贸n de Duplas</h3>
                    <div class="flex gap-2">
                        <button onclick="app.seedData()"
                            class="text-slate-500 hover:text-indigo-600 text-sm font-medium px-3 py-2 border border-slate-200 rounded-lg bg-white transition-colors"
                            title="Generar registros de prueba">
                            <i data-lucide="bot" class="w-4 h-4 inline mr-1"></i> Robots
                        </button>
                        <button onclick="app.loadAdminData()"
                            class="text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1 bg-indigo-50 px-3 py-2 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualizar
                        </button>
                        <button onclick="app.openModal('create-dupla-modal')"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i data-lucide="plus" class="w-4 h-4"></i> Nueva Dupla
                        </button>
                    </div>
                </div>

                <!-- Duplas Routes Grid -->
                <div id="duplas-routes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Recent Records Table -->
                <div class="glass-card rounded-xl overflow-hidden mt-8">
                    <div class="p-6 border-b border-slate-100">
                        <h4 class="font-semibold text-slate-800">Registros Recientes</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-medium">
                                <tr>
                                    <th class="px-6 py-4">Fecha</th>
                                    <th class="px-6 py-4">Mentor</th>
                                    <th class="px-6 py-4">Mentee</th>
                                    <th class="px-6 py-4">Tema</th>
                                    <th class="px-6 py-4">Duraci贸n</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Session Modal -->
    <div id="session-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
            onclick="app.closeModal('session-modal')"></div>
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-4 pointer-events-none">
            <div
                class="bg-white w-full max-w-lg md:rounded-2xl rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full md:translate-y-0 pointer-events-auto max-h-[90vh] overflow-y-auto">
                <div
                    class="sticky top-0 bg-white z-10 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Registrar Sesi贸n</h3>
                    <button onclick="app.closeModal('session-modal')"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <form id="session-form" onsubmit="event.preventDefault(); app.submitSession()" class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Fecha de la sesi贸n</label>
                        <input type="date" name="fecha" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <!-- Guided Session Selector -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">驴En qu茅 etapa de la Ruta
                            est谩n?</label>
                        <select name="etapa" onchange="app.updateSessionContext(this.value)"
                            class="w-full px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-indigo-900 font-medium">
                            <option value="" disabled selected>Selecciona la Fase del Proceso...</option>
                            <option value="Fase 1: Alineaci贸n + Mapa">Fase 1: Alineaci贸n + Mapa (Semana 1)</option>
                            <option value="Fase 2: Inmersi贸n T茅cnica">Fase 2: Inmersi贸n T茅cnica (Semana 2)</option>
                            <option value="Fase 3: Conocimiento T谩cito">Fase 3: Conocimiento T谩cito (Semana 3)</option>
                            <option value="Fase 4: Pr谩ctica Supervisada">Fase 4: Pr谩ctica Supervisada (Semana 4)
                            </option>
                            <option value="Fase 5: Co-creaci贸n y Mejora">Fase 5: Co-creaci贸n y Plan de Mejora (Semana 5)
                            </option>
                            <option value="Fase 6: Cierre de Brecha">Fase 6: Evaluaci贸n y Cierre (Semana 6)</option>
                            <option value="Sesi贸n Extra">Sesi贸n de Seguimiento Extra</option>
                        </select>
                        <!-- Dynamic Tip Area -->
                        <div id="session-tip"
                            class="hidden mt-3 p-3 bg-blue-50 border border-blue-100 rounded-lg text-xs text-blue-800 flex items-start gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                            <span id="session-tip-text">Selecciona una etapa para ver consejos clave.</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tema tratado</label>
                        <input type="text" name="tema" id="input-tema" required
                            placeholder="Se llenar谩 autom谩ticamente o escribe uno..."
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Fecha</label>
                            <input type="date" name="fecha" required
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Duraci贸n</label>
                            <div class="flex items-center gap-2">
                                <input type="time" name="hora_inicio" required
                                    class="w-full px-2 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs">
                                <span class="text-slate-400">-</span>
                                <input type="time" name="hora_fin" required
                                    class="w-full px-2 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Compromisos / Notas</label>
                        <textarea name="compromisos" rows="3"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Evidencia (Opcional)</label>
                        <div
                            class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:bg-slate-50 transition-colors cursor-pointer relative">
                            <input type="file" id="evidence-file"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="app.handleFileSelect(this)">
                            <div id="file-placeholder">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-indigo-400 mx-auto mb-2"></i>
                                <p class="text-sm text-slate-500">Click para subir foto o documento</p>
                            </div>
                            <div id="file-selected"
                                class="hidden flex items-center justify-center gap-2 text-indigo-600 font-medium">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                                <span id="file-name">archivo.pdf</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="submit-btn"
                            class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>Guardar Sesi贸n</span>
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Dupla Modal -->
    <div id="create-dupla-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
            onclick="app.closeModal('create-dupla-modal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div
                class="bg-white w-full max-w-lg rounded-2xl shadow-2xl pointer-events-auto max-h-[90vh] overflow-y-auto">
                <div
                    class="sticky top-0 bg-white z-10 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Crear Nueva Dupla</h3>
                    <button onclick="app.closeModal('create-dupla-modal')"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <form id="create-dupla-form" onsubmit="event.preventDefault(); app.createDupla()" class="p-6 space-y-4">
                    <div class="space-y-4">
                        <h4 class="font-bold text-slate-800 border-b pb-2">Datos del Mentor</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Mentor</label>
                                <input type="text" name="mentor" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Email Mentor</label>
                                <input type="email" name="mentorEmail" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Foto URL (Opcional)</label>
                                <input type="url" name="mentorPhoto" placeholder="https://..."
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xs">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Rese帽a / Bio
                                    (Opcional)</label>
                                <textarea name="mentorBio" rows="1" placeholder="Experiencia breve..."
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xs resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 mt-6">
                        <h4 class="font-bold text-slate-800 border-b pb-2">Datos del Mentee</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Mentee</label>
                                <input type="text" name="mentee" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Email Mentee</label>
                                <input type="email" name="menteeEmail" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Foto URL (Opcional)</label>
                                <input type="url" name="menteePhoto" placeholder="https://..."
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xs">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Rese帽a / Bio
                                    (Opcional)</label>
                                <textarea name="menteeBio" rows="1" placeholder="Expectativas..."
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xs resize-none"></textarea>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">rea / Proceso</label>
                        <input type="text" name="area" required placeholder="Ej: Recursos Humanos"
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Objetivo (Opcional)</label>
                        <textarea name="goal" rows="2"
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition-colors">
                            Crear y Enviar Invitaciones
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script Logic (Preserved) -->
    <script>
        window.app = {
            apiUrl: document.getElementById('api-url').value,
            currentUser: null,
            sessions: [],
            isLoading: false,

            init: function () {
                lucide.createIcons();
                this.checkSession();
            },

            setLoading: function (loading) {
                this.isLoading = loading;
                // Add/remove global loading overlay if desired, or disable buttons
                const btn = document.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = loading;
                    btn.classList.toggle('opacity-50', loading);
                    btn.innerHTML = loading ?
                        `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Guardando...` :
                        `<span>Guardar Sesi贸n</span><i data-lucide="save" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            },

            showToast: function (message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="p-2 rounded-full ${type === 'success' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                        <i data-lucide="${type === 'success' ? 'check' : 'alert-circle'}" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-800">${type === 'success' ? '隆xito!' : 'Error'}</h4>
                        <p class="text-sm text-slate-500">${message}</p>
                    </div>
                `;
                container.appendChild(toast);
                lucide.createIcons();

                if (type === 'success') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

                setTimeout(() => {
                    toast.style.animation = 'toastIn 0.4s reverse forwards';
                    setTimeout(() => toast.remove(), 400);
                }, 4000);
            },

            showView: function (viewId) {
                ['login-view', 'workspace-view', 'admin-view'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
                document.getElementById(viewId).classList.add('fade-in');
            },

            checkSession: function () {
                const user = localStorage.getItem('mentoring_user');
                if (user) {
                    this.currentUser = JSON.parse(user);
                    if (this.currentUser.email === 'admin' && this.currentUser.isAdmin) {
                        this.showView('admin-view');
                        this.loadAdminData();
                    } else {
                        this.loadUserData();
                    }
                } else {
                    this.showView('login-view');
                }
            },

            login: function () {
                const emailInput = document.getElementById('email-input');
                const email = emailInput.value.trim().toLowerCase();

                if (!email) return this.showToast('Por favor ingresa tu correo', 'error');

                // Simulation for Admin
                if (email === 'admin') {
                    const pass = prompt('Contrase帽a de administrador:');
                    if (pass === 'admin123') {
                        this.currentUser = { email: 'admin', isAdmin: true };
                        localStorage.setItem('mentoring_user', JSON.stringify(this.currentUser));
                        this.showView('admin-view');
                        this.loadAdminData();
                        return;
                    } else {
                        return this.showToast('Contrase帽a incorrecta', 'error');
                    }
                }

                // Normal Login - Check Role
                this.setLoading(true);
                fetch(this.apiUrl + '?action=getUserRole&email=' + email)
                    .then(r => r.json())
                    .then(res => {
                        this.setLoading(false);
                        if (res.status === 'success' && res.data) {
                            this.currentUser = {
                                email: email,
                                ...res.data, // role, pairId, name, partnerName, area
                                isAdmin: false
                            };
                            localStorage.setItem('mentoring_user', JSON.stringify(this.currentUser));
                            this.loadUserData();
                        } else {
                            this.showToast('Usuario no encontrado en la base de datos', 'error');
                        }
                    })
                    .catch(e => {
                        this.setLoading(false);
                        this.showToast('Error de conexi贸n', 'error');
                    });
            },

            logout: function () {
                localStorage.removeItem('mentoring_user');
                this.currentUser = null;
                location.reload();
            },

            loadUserData: function () {
                this.showView('workspace-view');
                document.getElementById('user-name-display').textContent = this.currentUser.name || this.currentUser.email.split('@')[0];
                document.getElementById('user-role-display').textContent = this.currentUser.role || 'Usuario';

                // Emotional Design: Dynamic Greeting
                const hour = new Date().getHours();
                let greeting = "Hola";
                if (hour < 12) greeting = "Buenos d铆as";
                else if (hour < 18) greeting = "Buenas tardes";
                else greeting = "Buenas noches";

                document.getElementById('greeting-text').textContent = greeting;
                document.getElementById('welcome-name').textContent = this.currentUser.name ? this.currentUser.name.split(' ')[0] : 'Compa帽ero';

                // Emotional Design: Daily Spark
                const quotes = [
                    "El liderazgo no es un cargo, es una acci贸n.",
                    "La mejor forma de predecir el futuro es cre谩ndolo.",
                    "Aprender es descubrir que algo es posible.",
                    "Peque帽os progresos cada d铆a suman grandes resultados.",
                    "Tu potencial es infinito, solo necesitas direcci贸n.",
                    "El mentor abre la puerta, pero t煤 debes entrar.",
                    "La excelencia es un h谩bito, no un acto."
                ];
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('spark-quote').textContent = randomQuote;
                document.getElementById('daily-spark').classList.remove('hidden');

                // Set Avatar
                if (this.currentUser.photo) {
                    document.getElementById('sidebar-avatar').src = this.currentUser.photo;
                } else {
                    // Fallback using UI Avatars
                    document.getElementById('sidebar-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(this.currentUser.name)}&background=random`;
                }

                // Fetch sessions from backend
                this.fetchSessions();
            },

            fetchSessions: function () {
                // In a real app, you would fetch from Google Sheets here
                // For now, we simulate or use the actual endpoint if available
                // Using the apiUrl defined

                const scriptUrl = this.apiUrl + `?action=getSessions&email=${this.currentUser.email}`;

                fetch(scriptUrl)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.sessions = data.data;
                            this.renderSessions();
                            this.updateProgress();
                        }
                    })
                    .catch(e => console.error("Error loading sessions", e));
            },

            renderSessions: function () {
                const list = document.getElementById('sessions-list');
                const totalEl = document.getElementById('total-sessions');

                if (this.sessions.length === 0) {
                    list.innerHTML = `
                        <div class="glass glass-card p-8 rounded-2xl text-center text-slate-500">
                            <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-3 text-slate-300"></i>
                            <p>No hay sesiones registradas a煤n</p>
                        </div>`;
                    totalEl.textContent = '0';
                    lucide.createIcons();
                    return;
                }

                totalEl.textContent = this.sessions.length;

                // Group Sessions by Date
                const groups = {};
                // Sort descending date first
                const sortedSessions = [...this.sessions].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedSessions.forEach(s => {
                    const d = new Date(s.date).toLocaleDateString(); // Simple grouping key
                    if (!groups[d]) groups[d] = [];
                    groups[d].push(s);
                });

                list.className = "space-y-8 relative pl-8 border-l-2 border-slate-200 ml-4";

                let htmlContent = '';

                Object.keys(groups).forEach(dateKey => {
                    const groupSessions = groups[dateKey];

                    // Group Header Node
                    htmlContent += `
                    <div class="relative pl-4 group">
                         <!-- Timeline Node Date -->
                        <div class="absolute -left-[45px] top-0 w-7 h-7 rounded-lg bg-indigo-600 border-2 border-indigo-100 flex items-center justify-center shadow-md z-10 text-white font-bold text-xs title="${dateKey}">
                            <i data-lucide="calendar-days" class="w-3 h-3"></i>
                        </div>
                        
                        <div class="mb-4 pl-2">
                             <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider bg-indigo-50 px-2 py-1 rounded-md">${dateKey}</span>
                        </div>
                    `;

                    // Render cards in this group
                    groupSessions.forEach((s, i) => {
                        htmlContent += `
                        <div class="glass glass-card p-6 rounded-2xl mb-4 hover:border-indigo-400/50 transition-all hover:-translate-y-1 border-l-4 ${s.role === 'Mentor' ? 'border-l-indigo-500' : 'border-l-emerald-500'}">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xs font-bold text-slate-500 flex items-center gap-1">
                                            <i data-lucide="user" class="w-3 h-3"></i> ${s.role === 'Mentor' ? 'Mentor' : 'Mentee'}: ${s.role === 'Mentor' ? s.mentor : s.mentee}
                                        </span>
                                    </div>
                                    <h4 class="font-bold text-slate-800 text-xl">${s.title}</h4>
                                    <div class="mt-3 p-3 bg-slate-50/50 rounded-lg border border-slate-100">
                                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Compromisos / Notas</span>
                                        <p class="text-slate-600 text-sm leading-relaxed italic">"${s.compromisos || s.summary || 'Sin registro'}"</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2 text-sm font-medium">
                                    <div class="px-3 py-1.5 rounded-lg bg-slate-50 text-slate-600 flex items-center gap-2 border border-slate-200">
                                        <i data-lucide="clock" class="w-4 h-4 text-purple-500"></i>
                                        <span>${s.duration || '1.0'}h</span>
                                    </div>
                                    ${s.file ? `<a href="${s.file}" target="_blank" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors text-xs font-bold border border-indigo-100">
                                        <i data-lucide="download" class="w-3 h-3"></i> Ver Evidencia
                                    </a>` : ''}
                                    
                                    <!-- Edit Button (Only Today) -->
                                    ${new Date(s.date).toDateString() === new Date().toDateString() ?
                                `<button onclick='app.editSession(${JSON.stringify(s).replace(/'/g, "&#39;")})' class="p-1.5 rounded-lg bg-slate-100 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors" title="Editar Sesi贸n">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>`;
                    });

                    htmlContent += `</div>`;
                });

                list.innerHTML = htmlContent;
                lucide.createIcons();
            },

            updateProgress: function () {
                const count = this.sessions.length;
                const max = 6; // Goal
                const percentage = Math.min((count / max) * 100, 100);

                document.getElementById('completed-count').textContent = count;

                // Animate circle
                const circle = document.getElementById('progress-ring');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                const offset = circumference - (percentage / 100) * circumference;

                circle.style.strokeDashoffset = offset;
            },

            updateSessionContext: function (stageName) {
                const temaInput = document.getElementById('input-tema');
                const tipArea = document.getElementById('session-tip');
                const tipText = document.getElementById('session-tip-text');

                // Auto-Fill Title
                temaInput.value = stageName;

                // Business Logic Tips (Based on User's Chart)
                const tips = {
                    'Fase 1: Alineaci贸n + Mapa': 'Producto Clave: Cronograma de sesiones + Lista de procesos cr铆ticos.',
                    'Fase 2: Inmersi贸n T茅cnica': 'Producto Clave: Checklist de herramientas. Revisi贸n de normativas y software.',
                    'Fase 3: Conocimiento T谩cito': 'Producto Clave: Matriz de Lecciones + Contactos clave. Manejo de Crisis.',
                    'Fase 4: Pr谩ctica Supervisada': 'Producto Clave: Bit谩cora de ejecuci贸n. Pr谩ctica con feedback en tiempo real.',
                    'Fase 5: Co-creaci贸n y Mejora': 'Producto Clave: Anteproyecto o Plan de Acci贸n de Mejora para el 谩rea.',
                    'Fase 6: Cierre de Brecha': 'Producto Clave: Informe final de transferencia y presentaci贸n a direcci贸n.'
                };

                if (tips[stageName]) {
                    tipArea.classList.remove('hidden');
                    tipText.textContent = tips[stageName];
                } else {
                    tipArea.classList.add('hidden');
                }
            },

            openModal: function (modalId) {
                if (modalId === 'session-modal' && !this.editingSessionId) {
                    // Reset title if new session
                    document.querySelector('#session-modal h3').textContent = "Registrar Sesi贸n";
                    document.getElementById('session-form').reset();

                    // SMART AUTO-ADVANCE LOGIC
                    const select = document.querySelector('select[name="etapa"]');
                    const sessionCount = this.sessions ? this.sessions.length : 0;

                    // Mapeo: 0 sessions -> Index 1 (Fase 1), 1 session -> Index 2 (Fase 2), etc.
                    let targetIndex = sessionCount + 1;

                    // Safety check: If all phases done, default to "Sesi贸n Extra" (Last option)
                    if (targetIndex >= select.options.length) {
                        targetIndex = select.options.length - 1;
                    }

                    select.selectedIndex = targetIndex;

                    // Auto-trigger context to show Title and Tip immediately
                    this.updateSessionContext(select.value);
                }
                document.getElementById(modalId).classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },

            closeModal: function (modalId) {
                document.getElementById(modalId).classList.add('hidden');
                document.body.style.overflow = '';

                // Reset Animation for Dupla Modal
                if (modalId === 'dupla-detail-modal') {
                    const content = document.getElementById('dupla-detail-content');
                    content.classList.add('opacity-0', 'scale-95');
                    content.classList.remove('opacity-100', 'scale-100');
                }
            },

            handleFileSelect: function (input) {
                const file = input.files[0];
                if (file) {
                    document.getElementById('file-placeholder').classList.add('hidden');
                    document.getElementById('file-selected').classList.remove('hidden');
                    document.getElementById('file-name').textContent = file.name;
                }
            },

            editSession: function (session) {
                // Populate Form
                const form = document.getElementById('session-form');
                form.fecha.value = session.date ? new Date(session.date).toISOString().split('T')[0] : '';
                form.tema.value = session.title;
                form.hora_inicio.value = ""; // Force re-entry for calculation safety or logic complexity
                form.hora_fin.value = "";
                form.compromisos.value = session.compromisos || session.summary;

                this.editingSessionId = session.sessionId;
                this.openModal('session-modal');

                // Update Modal Title (Optional UX)
                document.querySelector('#session-modal h3').textContent = "Editar Sesi贸n";
            },

            submitSession: function () {
                this.setLoading(true);
                const form = document.getElementById('session-form');
                const formData = new FormData(form);
                const fileInput = document.getElementById('evidence-file');

                const sessionData = {
                    action: 'SaveSession',
                    pairId: this.currentUser.pairId,
                    mentorName: this.currentUser.role === 'Mentor' ? this.currentUser.name : this.currentUser.partnerName,
                    menteeName: this.currentUser.role === 'Mentee' ? this.currentUser.name : this.currentUser.partnerName,
                    role: this.currentUser.role,
                    area: this.currentUser.area,

                    email: this.currentUser.email,
                    fecha: formData.get('fecha'),
                    tema: formData.get('tema'),
                    hora_inicio: formData.get('hora_inicio'),
                    hora_fin: formData.get('hora_fin'),
                    compromisos: formData.get('compromisos'),
                    category: formData.get('etapa') || "Sesi贸n Standard", // New Field
                    sessionId: this.editingSessionId || "" // Send ID if editing
                };

                // Helper to send fields
                const proceed = () => {
                    this.sendData(sessionData);
                    this.editingSessionId = null; // Reset
                };

                // Handle file upload if present
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        sessionData.fileContent = e.target.result;
                        sessionData.fileName = file.name;
                        sessionData.mimeType = file.type;
                        proceed();
                    };
                    reader.readAsDataURL(file);
                } else {
                    proceed();
                }
            },

            sendData: function (data) {
                fetch(this.apiUrl, {
                    method: 'POST',
                    body: JSON.stringify(data)
                })
                    .then(r => r.json())
                    .then(response => {
                        this.setLoading(false);
                        if (response.status === 'success') {
                            this.showToast('隆Sesi贸n registrada con 茅xito! ');
                            // Emotional Design: Victory Confetti
                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 }
                            });
                            this.closeModal('session-modal');
                            document.getElementById('session-form').reset();
                            // Reset file input UI
                            document.getElementById('file-placeholder').classList.remove('hidden');
                            document.getElementById('file-selected').classList.add('hidden');
                            // Refresh data
                            this.fetchSessions();
                        } else {
                            this.showToast('Error al guardar: ' + response.message, 'error');
                        }
                    })
                    .catch(err => {
                        this.setLoading(false);
                        this.showToast('Error de conexi贸n', 'error');
                        console.error(err);
                    });
            },

            seedData: function () {
                if (!confirm('驴Generar datos de prueba? Esto crear谩 duplas y sesiones aleatorias.')) return;

                const btn = event.currentTarget; // Quick ref
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="animate-spin w-4 h-4 mr-1 inline" data-lucide="loader-2"></i> ...';
                btn.disabled = true;

                fetch(this.apiUrl + '?action=seedData')
                    .then(r => r.json())
                    .then(res => {
                        this.showToast('Datos generados con 茅xito', 'success');
                        this.loadAdminData();
                    })
                    .catch(err => this.showToast('Error generando datos', 'error'))
                    .finally(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        lucide.createIcons();
                    });
            },

            loadAdminData: function () {
                const scriptUrl = this.apiUrl + `?action=getAdminData`;
                fetch(scriptUrl)
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            this.renderAdminDashboard(res.data);
                        }
                    });
            },

            renderAdminDashboard: function (data) {
                this.adminData = data; // Store for Detail View
                // KPIs
                document.getElementById('kpi-total').textContent = data.kpis.totalSessions;
                document.getElementById('kpi-active').textContent = data.kpis.activeDuplas;
                document.getElementById('kpi-hours').textContent = data.kpis.totalHours;
                document.getElementById('kpi-avg').textContent = data.kpis.avgSessions;

                // Dupla Routes Grid
                const grid = document.getElementById('duplas-routes-grid');
                if (data.duplasProgress) {
                    grid.innerHTML = data.duplasProgress.map((d, index) => {
                        // Progress Bar Logic
                        const progress = Math.min((d.count / d.goal) * 100, 100);
                        const isCompleted = d.status === 'completed';
                        const statusColor = isCompleted ? 'bg-emerald-500' : (d.status === 'active' ? 'bg-indigo-500' : 'bg-slate-300');

                        return `
                            <div onclick="app.viewDuplaDetails(${index})" class="glass glass-card p-6 rounded-2xl relative group hover:-translate-y-1 transition-transform z-0 hover:z-10 cursor-pointer">
                            <!--Status Bar(Manually rounded to avoid overflow: hidden clipping the tooltips)-->
                            <div class="absolute top-0 left-0 w-1.5 h-full ${statusColor} rounded-l-2xl"></div>
                            
                            <div class="flex justify-between items-start mb-4 pl-3">
                                <div class="flex -space-x-3">
                                    <!-- Mentor Avatar -->
                                    <div class="relative group/avatar cursor-help">
                                        ${d.mentorPhoto ?
                                `<img src="${d.mentorPhoto}" class="w-10 h-10 rounded-full border-2 border-white object-cover shadow-sm" alt="Mentor">` :
                                `<div class="w-10 h-10 rounded-full border-2 border-white bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-600 shadow-sm">${d.mentor.split(' ').map(n => n[0]).join('').substring(0, 2)}</div>`
                            }
                                        <!-- Premium Tooltip Mentor -->
                                        ${d.mentorBio ? `
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 w-64 p-4 bg-slate-800/95 backdrop-blur-sm text-white text-xs rounded-xl opacity-0 group-hover/avatar:opacity-100 transition-all duration-300 transform group-hover/avatar:-translate-y-1 pointer-events-none z-50 shadow-2xl border border-slate-700">
                                            <div class="font-bold text-indigo-300 mb-1 border-b border-slate-600 pb-1">${d.mentor}</div>
                                            <p class="leading-relaxed text-slate-300">${d.mentorBio}</p>
                                            <!-- Arrow -->
                                            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                                        </div>` : ''}
                                    </div>

                                    <!-- Mentee Avatar -->
                                    <div class="relative group/avatar cursor-help">
                                         ${d.menteePhoto ?
                                `<img src="${d.menteePhoto}" class="w-10 h-10 rounded-full border-2 border-white object-cover bg-white shadow-sm" alt="Mentee">` :
                                `<div class="w-10 h-10 rounded-full border-2 border-white bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-600 shadow-sm">${d.mentee.split(' ').map(n => n[0]).join('').substring(0, 2)}</div>`
                            }
                                        <!-- Premium Tooltip Mentee -->
                                        ${d.menteeBio ? `
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 w-64 p-4 bg-slate-800/95 backdrop-blur-sm text-white text-xs rounded-xl opacity-0 group-hover/avatar:opacity-100 transition-all duration-300 transform group-hover/avatar:-translate-y-1 pointer-events-none z-50 shadow-2xl border border-slate-700">
                                            <div class="font-bold text-emerald-300 mb-1 border-b border-slate-600 pb-1">${d.mentee}</div>
                                            <p class="leading-relaxed text-slate-300">${d.menteeBio}</p>
                                            <!-- Arrow -->
                                            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                                        </div>` : ''}
                                    </div>
                                </div>

                                <span class="px-2 py-1 rounded-md text-xs font-bold uppercase shadow-sm border ${d.status === 'completed' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-600 border-slate-200'}">
                                    ${d.status === 'completed' ? 'Completado' : (d.status === 'active' ? 'En Curso' : 'Inactivo')}
                                </span>
                            </div>
                            
                            <div class="mb-4 pl-3">
                                <h4 class="font-bold text-slate-800 text-sm leading-tight">${d.mentor} <span class="text-indigo-400">&</span> <br>${d.mentee}</h4>
                                <p class="text-xs text-slate-500 mt-1">ltima sesi贸n: ${d.lastSession ? new Date(d.lastSession).toLocaleDateString() : 'N/A'}</p>
                            </div>

                            <!-- Progress Bar -->
                            <div class="space-y-1 pl-3">
                                <div class="flex justify-between text-xs font-medium text-slate-500">
                                    <span>Progreso</span>
                                    <span>${d.count} / ${d.goal}</span>
                                </div>
                                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-100">
                                    <div class="h-full ${statusColor} transition-all duration-1000" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    grid.innerHTML = '<p class="text-slate-500 col-span-3 text-center py-8">No hay datos de duplas disponibles.</p>';
                }

                // Table
                const tbody = document.getElementById('admin-table-body');
                tbody.innerHTML = data.recentSessions.map(s => `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-6 py-4 text-slate-600">${new Date(s.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-medium text-slate-800">${s.mentor}</td>
                        <td class="px-6 py-4 text-slate-600">${s.mentee}</td>
                        <td class="px-6 py-4 text-slate-600">${s.title}</td>
                        <td class="px-6 py-4 text-slate-500">${s.duration || 1}h</td>
                    </tr>
                `).join('');

                this.renderCharts(data.charts);
                lucide.createIcons();
            },

            renderCharts: function (data) {
                // Sessions Chart (Area)
                const ctx1 = document.getElementById('sessionsChart').getContext('2d');

                // Destroy existing chart if it exists
                if (this.sessionsChartInstance) {
                    this.sessionsChartInstance.destroy();
                }

                // Create gradient
                const gradient = ctx1.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)'); // Indigo
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

                this.sessionsChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.sessionsByMonth.labels,
                        datasets: [{
                            label: 'Sesiones',
                            data: data.sessionsByMonth.data,
                            borderColor: '#4f46e5',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#4f46e5',
                            pointHoverBackgroundColor: '#4f46e5',
                            pointHoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } }, // Minimalist
                        scales: {
                            y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                // Status Chart (Doughnut)
                const ctx2 = document.getElementById('statusChart').getContext('2d');

                // Destroy existing chart if it exists
                if (this.statusChartInstance) {
                    this.statusChartInstance.destroy();
                }

                this.statusChartInstance = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Activas', 'Inactivas', 'Completadas'],
                        datasets: [{
                            data: [data.status.active, data.status.inactive, data.status.completed],
                            backgroundColor: ['#4f46e5', '#cbd5e1', '#10b981'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                        }
                    }
                });
            }
        };

        // Initialize simplified sendData for generic use or override in createDupla
        app.createDupla = function () {
            const btn = document.querySelector('#create-dupla-form button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Procesando...";

            const form = document.getElementById('create-dupla-form');
            const formData = new FormData(form);
            const data = {
                action: 'createDupla',
                mentor: formData.get('mentor'),
                mentorEmail: formData.get('mentorEmail'),
                mentee: formData.get('mentee'),
                menteeEmail: formData.get('menteeEmail'),
                mentorPhoto: formData.get('mentorPhoto'),
                mentorBio: formData.get('mentorBio'),
                menteePhoto: formData.get('menteePhoto'),
                menteeBio: formData.get('menteeBio'),
                area: formData.get('area'),
                goal: formData.get('goal')
            };

            fetch(this.apiUrl, {
                method: 'POST',
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(res => {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    if (res.status === 'success') {
                        this.showToast('Dupla creada y correos enviados');
                        this.closeModal('create-dupla-modal');
                        form.reset();
                        this.loadAdminData();
                    } else {
                        this.showToast('Error: ' + res.message, 'error');
                    }
                })
                .catch(e => {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    this.showToast('Error de conexi贸n', 'error');
                });
        };

        // NEW: Maximize Dupla View
        app.viewDuplaDetails = function (index) {
            console.log("Viewing Dupla Details for index:", index);
            // Guard: check if data exists
            if (!this.adminData) {
                console.error("Admin Data missing in viewDuplaDetails");
                alert("Error: Admin Data sent to frontend is null. Try refreshing.");
                return;
            }
            if (!this.adminData.duplasProgress[index]) {
                console.error("Dupla index not found:", index);
                return;
            }
            const dupla = this.adminData.duplasProgress[index];

            // Populate Header
            document.getElementById('detail-mentor').textContent = dupla.mentor;
            document.getElementById('detail-mentee').textContent = dupla.mentee;
            document.getElementById('detail-area').textContent = dupla.area || 'N/A';
            // Use goal description if available, else generic
            document.getElementById('detail-objective').textContent = dupla.goalDescription || "Desarrollo de competencias y crecimiento profesional.";

            // Populate Progress
            document.getElementById('detail-progress-count').textContent = dupla.count;
            document.getElementById('detail-goal').textContent = dupla.goal;
            const pct = Math.min((dupla.count / dupla.goal) * 100, 100);
            document.getElementById('detail-progress-bar').style.width = `${pct}%`;

            // Filter Recent Sessions for this pair (Client-side filtered from dashboard data)
            const history = this.adminData.recentSessions.filter(s =>
                s.mentor === dupla.mentor && s.mentee === dupla.mentee
            );

            const list = document.getElementById('detail-sessions-list');
            if (history.length > 0) {
                list.innerHTML = history.map(s => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <div>
                            <p class="text-sm font-bold text-slate-800">${s.title}</p>
                            <p class="text-xs text-slate-500">${new Date(s.date).toLocaleDateString()} 路 ${s.duration || 1}h</p>
                        </div>
                        <div class="px-2 py-1 rounded bg-indigo-50 text-indigo-600 text-xs font-bold">
                            Completada
                        </div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="text-slate-400 text-sm italic">No hay sesiones en el historial reciente.</p>';
            }

            this.openModal('dupla-detail-modal');

            // Animation Trigger
            setTimeout(() => {
                const content = document.getElementById('dupla-detail-content');
                content.classList.remove('opacity-0', 'scale-95');
                content.classList.add('opacity-100', 'scale-100');
            }, 10);
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>

    <!-- Dupla Detail Modal -->
    <div id="dupla-detail-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity"
            onclick="app.closeModal('dupla-detail-modal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform transition-transform duration-300 scale-95 opacity-0 pointer-events-auto flex flex-col max-h-[90vh]"
                id="dupla-detail-content">
                <!-- Header -->
                <div
                    class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/50 rounded-t-2xl">
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <span id="detail-mentor">Mentor</span>
                            <span class="text-indigo-400">&</span>
                            <span id="detail-mentee">Mentee</span>
                        </h3>
                        <p class="text-slate-500 text-sm mt-1" id="detail-area">Area</p>
                    </div>
                    <button onclick="app.closeModal('dupla-detail-modal')"
                        class="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto space-y-8">
                    <!-- Progress Section -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="col-span-1 glass-card p-6 rounded-xl bg-indigo-50/50 border-indigo-100">
                            <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2">Progreso General
                            </p>
                            <div class="flex items-end gap-2 mb-2">
                                <span id="detail-progress-count" class="text-4xl font-bold text-indigo-700">0</span>
                                <span class="text-indigo-400 font-medium mb-1">/ <span id="detail-goal">6</span>
                                    Sesiones</span>
                            </div>
                            <div class="h-2 w-full bg-indigo-200 rounded-full overflow-hidden">
                                <div id="detail-progress-bar" class="h-full bg-indigo-500 transition-all duration-1000"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-span-2 space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center">
                                    <i data-lucide="lightbulb" class="w-6 h-6 text-amber-500"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-700">Objetivo del Mentoring</p>
                                    <p id="detail-objective" class="text-slate-600 text-sm italic">"..."</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Session History Timeline -->
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
                            Historial de Sesiones
                        </h4>
                        <div id="detail-sessions-list" class="space-y-3">
                            <!-- Populated via JS -->
                            <p class="text-slate-400 text-sm">Cargando historial...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
